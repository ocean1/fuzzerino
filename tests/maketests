# Makefile
.PHONY: FORCE all clean

DEBUG ?= 0
EMIT_LLVM ?= 0
OPT ?= opt

CC ?= gfz-clang-fast

CFLAGS = -Wall
CFLAGS += -I ../
LLVMFLAGS = -emit-llvm -S

#LDFLAGS += ../ldscript.x
ifeq ($(DEBUG), 1)
	CFLAGS  += -g
endif

all: gtest ptest

cleanids:
	@rm -f /dev/shm/gfzidfile

gtest:
	# Emit LLVM IR of test program with instrumentation
	@rm -f /dev/shm/gfzidfile
	$(CC) $(CFLAGS) $(LDFLAGS) -S -emit-llvm g.c -o $@.ll
	
	# Verify LLVM IR of test program with instrumentation
	$(OPT) -verify $@.ll -o /dev/null

	# Build test program with instrumentation
	@rm -f /dev/shm/gfzidfile
	$(CC) $(CFLAGS) $(LDFLAGS) g.c -o $@
	
ptest:
	@rm -f /dev/shm/gfzidfile
	gcc $(CFLAGS) $(LDFLAGS) p.c -o $@

clean:
	rm -f gtest ptest
	rm -f *.o
	rm -f *.ll
